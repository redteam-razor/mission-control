<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mission Control</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--green:#00ff41;--dark-green:#008f11;--bg:#0a0a0a;--panel:#0d1117;--border:#1a3a1a;--dim:#4a7a4a;--glow:0 0 10px rgba(0,255,65,.3)}
body{font-family:'Courier New',monospace;background:var(--bg);color:var(--green);height:100vh;overflow:hidden;font-size:.85rem}
canvas#matrix-bg{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;opacity:.06}
#app{position:relative;z-index:1;display:flex;height:100vh}
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}
#header{padding:16px 24px;border-bottom:1px solid var(--border);background:rgba(10,10,10,.85);backdrop-filter:blur(8px)}
#header h1{font-size:1.4rem;text-shadow:var(--glow);letter-spacing:2px}
#header .subtitle{color:var(--dim);font-size:.7rem;max-width:600px;line-height:1.5;margin-top:6px}
#content{flex:1;overflow-y:auto;padding:24px;background:rgba(10,10,10,.7)}
#content::-webkit-scrollbar{width:6px}
#content::-webkit-scrollbar-thumb{background:var(--dark-green);border-radius:3px}
#sidebar{width:72px;background:rgba(13,17,23,.9);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding-top:12px;gap:4px;backdrop-filter:blur(8px);order:-1}
.tab-btn{width:56px;padding:8px 4px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:none;background:transparent;color:var(--dim);cursor:pointer;border-radius:6px;transition:all .2s;gap:3px}
.tab-btn:hover{background:rgba(0,255,65,.08);color:var(--green)}
.tab-btn.active{background:rgba(0,255,65,.12);color:var(--green);box-shadow:var(--glow)}
.tab-icon{font-size:.85rem;font-family:'Courier New',monospace;font-weight:bold;color:inherit}
.tab-label{font-size:.65rem;color:inherit;font-family:'Courier New',monospace}
button,.btn{background:transparent;color:var(--green);border:1px solid var(--dark-green);padding:8px 16px;font-family:inherit;font-size:.8rem;cursor:pointer;border-radius:4px;transition:all .2s}
button:hover,.btn:hover{background:rgba(0,255,65,.15);box-shadow:var(--glow)}
input,textarea,select{background:rgba(0,255,65,.05);border:1px solid var(--border);color:var(--green);padding:8px 12px;font-family:inherit;font-size:.85rem;border-radius:4px;width:100%}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--dark-green);box-shadow:var(--glow)}
textarea{resize:vertical;min-height:80px}
select option{background:var(--bg);color:var(--green)}
.card{background:rgba(13,17,23,.8);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.7rem;border:1px solid}
.badge.pending{border-color:#ff6;color:#ff6}
.badge.in-progress{border-color:#0af;color:#0af}
.badge.done{border-color:var(--green);color:var(--green)}
.badge.draft{border-color:#ff6;color:#ff6}
.badge.review{border-color:#0af;color:#0af}
.badge.published{border-color:var(--green);color:var(--green)}
.badge.urgent{border-color:#f44;color:#f44}
.badge.high{border-color:#f90;color:#f90}
.badge.medium{border-color:#ff6;color:#ff6}
.badge.low{border-color:var(--green);color:var(--green)}
.badge.business{border-color:#0af;color:#0af}
.badge.personal{border-color:#a6f;color:#a6f}
.badge.health{border-color:#0f6;color:#0f6}
.badge.family{border-color:#f6a;color:#f6a}
.badge.spiritual{border-color:#ff6;color:#ff6}
.badge.meeting{border-color:#0af;color:#0af}
.badge.deadline{border-color:#f44;color:#f44}
.due-overdue{color:#f44;font-weight:bold}
.due-today{color:#ff6;font-weight:bold}
.due-future{color:var(--dim)}
.task-desc{font-size:.75rem;color:var(--dim);margin-top:4px;max-height:2.4em;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.edit-btn{background:transparent;border:1px solid var(--dark-green);color:var(--green);padding:4px 8px;font-size:.7rem;cursor:pointer;border-radius:3px}
.edit-btn:hover{background:rgba(0,255,65,.15)}
h2{font-size:1.1rem;margin-bottom:16px;text-shadow:var(--glow);letter-spacing:1px}
.section-icon{color:var(--green);font-weight:bold}
.form-row{margin-bottom:12px}
.form-row label{display:block;font-size:.75rem;color:var(--dim);margin-bottom:4px}
.toolbar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.empty{color:var(--dim);text-align:center;padding:40px;font-size:.85rem}
.delete-btn{background:transparent;border:1px solid #600;color:#f66;padding:4px 8px;font-size:.7rem;cursor:pointer;border-radius:3px}
.delete-btn:hover{background:rgba(255,0,0,.15)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-header{text-align:center;font-size:.7rem;color:var(--dim);padding:4px}
.cal-day{aspect-ratio:1;border:1px solid var(--border);border-radius:4px;padding:4px;font-size:.65rem;position:relative;cursor:pointer;min-height:60px}
.cal-day:hover{border-color:var(--dark-green)}
.cal-day .num{font-size:.75rem;color:var(--dim)}
.cal-day.today .num{color:var(--green);font-weight:bold}
.cal-day.other{opacity:.3}
.cal-entry{background:rgba(0,255,65,.1);border-radius:2px;padding:1px 3px;margin-top:2px;font-size:.55rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:100;display:flex;align-items:center;justify-content:center}
.modal{background:var(--bg);border:1px solid var(--dark-green);border-radius:8px;padding:24px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 0 30px rgba(0,255,65,.15)}
.modal h3{margin-bottom:16px;text-shadow:var(--glow)}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
.loading-bar{text-align:center;color:var(--dim);padding:20px;font-size:.8rem}
.radar-stat{background:rgba(0,255,65,.05);border:1px solid var(--border);border-radius:6px;padding:12px 16px;text-align:center;min-width:100px}
.radar-stat .val{font-size:1.4rem;font-weight:bold;color:var(--green);text-shadow:var(--glow)}
.radar-stat .lbl{font-size:.65rem;color:var(--dim);margin-top:2px}
.insight-card{background:rgba(13,17,23,.8);border-radius:8px;padding:16px;margin-bottom:12px;position:relative;overflow:hidden}
.insight-card.strong{border:1px solid #0f6;box-shadow:0 0 15px rgba(0,255,65,.2)}
.insight-card.moderate{border:1px solid #ff6;box-shadow:0 0 10px rgba(255,255,0,.12)}
.insight-card.emerging{border:1px solid var(--border)}
.strength-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.65rem;font-weight:bold;text-transform:uppercase}
.strength-badge.strong{background:rgba(0,255,65,.15);color:#0f6;border:1px solid #0f6}
.strength-badge.moderate{background:rgba(255,255,0,.1);color:#ff6;border:1px solid #ff6}
.strength-badge.emerging{background:rgba(255,255,255,.05);color:var(--dim);border:1px solid var(--border)}
.src-badge{display:inline-block;padding:1px 6px;border-radius:8px;font-size:.6rem;border:1px solid var(--dim);color:var(--dim);margin-right:4px}
.radar-section{margin-bottom:24px}
.radar-section h3{font-size:.9rem;margin-bottom:10px;color:var(--green);text-shadow:0 0 6px rgba(0,255,65,.2)}
.radar-item{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid rgba(26,58,26,.4)}
.radar-item:hover{background:rgba(0,255,65,.04)}
.radar-item a{color:var(--green);text-decoration:none;font-size:.8rem;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.radar-item a:hover{text-decoration:underline}
.radar-item .metrics{display:flex;gap:8px;flex-shrink:0;font-size:.7rem;color:var(--dim);margin-left:12px}
.radar-tooltip{position:relative;cursor:help;color:var(--dim);font-size:.75rem;border-bottom:1px dashed var(--dim)}
.radar-tooltip:hover::after{content:attr(data-tip);position:absolute;bottom:100%;left:0;background:var(--bg);border:1px solid var(--dark-green);padding:8px 12px;font-size:.7rem;color:var(--green);white-space:normal;width:280px;z-index:10;border-radius:4px;box-shadow:0 0 12px rgba(0,255,65,.15)}
@media(max-width:768px){
  #sidebar{width:56px}
  .tab-btn{width:44px;padding:6px 2px}
  #content{padding:12px}
  .cal-day{min-height:40px}
}
</style>
</head>
<body>
<canvas id="matrix-bg"></canvas>
<div id="app">
  <div id="sidebar">
    <div class="tab-btn active" data-tab="brief" onclick="switchTab('brief')"><span class="tab-icon">‚óà</span><span class="tab-label">Brief</span></div>
    <div class="tab-btn" data-tab="radar" onclick="switchTab('radar')"><span class="tab-icon">‚óé</span><span class="tab-label">Radar</span></div>
    <div class="tab-btn" data-tab="tasks" onclick="switchTab('tasks')"><span class="tab-icon">‚ñ∫</span><span class="tab-label">Tasks</span></div>
    <div class="tab-btn" data-tab="calendar" onclick="switchTab('calendar')"><span class="tab-icon">‚óÜ</span><span class="tab-label">Calendar</span></div>
    <div class="tab-btn" data-tab="prompts" onclick="switchTab('prompts')"><span class="tab-icon">‚óá</span><span class="tab-label">Prompts</span></div>
    <div class="tab-btn" data-tab="documents" onclick="switchTab('documents')"><span class="tab-icon">‚ñ£</span><span class="tab-label">Docs</span></div>
    <div class="tab-btn" data-tab="content" onclick="switchTab('content')"><span class="tab-icon">‚ñ∂</span><span class="tab-label">Content</span></div>
  </div>
  <div id="main">
    <div id="header">
      <h1>‚¨° MISSION CONTROL</h1>
      <div class="subtitle">I am building financial independence through AI entrepreneurship so I can control my time, be fully present for my family, stay physically and spiritually strong, and use my skills to serve those who cannot help themselves‚Äîliving with purpose, faith, and integrity as an example for my children.</div>
    </div>
    <div id="content"><div class="loading-bar">[ CONNECTING TO DATABASE... ]</div></div>
  </div>
</div>

<script>
// ---- Matrix Rain ----
const c=document.getElementById('matrix-bg'),ctx=c.getContext('2d');
function resizeCanvas(){c.width=window.innerWidth;c.height=window.innerHeight}
resizeCanvas();window.addEventListener('resize',resizeCanvas);
const chars='„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥0123456789ABCDEF';
const fontSize=14,columns=()=>Math.floor(c.width/fontSize);
let drops=Array(columns()).fill(1);
function drawMatrix(){
  ctx.fillStyle='rgba(0,0,0,.05)';ctx.fillRect(0,0,c.width,c.height);
  ctx.fillStyle='#00ff41';ctx.font=fontSize+'px monospace';
  const cols=columns();
  if(drops.length!==cols)drops=Array(cols).fill(1);
  for(let i=0;i<cols;i++){
    const t=chars[Math.floor(Math.random()*chars.length)];
    ctx.fillText(t,i*fontSize,drops[i]*fontSize);
    if(drops[i]*fontSize>c.height&&Math.random()>.975)drops[i]=0;
    drops[i]++;
  }
}
setInterval(drawMatrix,50);

// ---- Neon Database (via API proxy) ----
async function neonQuery(sql, params=[]){
  const resp=await fetch('/api/db',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({query:sql,params})
  });
  const data=await resp.json();
  if(!resp.ok) throw new Error(data.error||'Database query failed');
  return data.rows;
}

const cache={tasks:[],calendar:[],prompts:[],documents:[],content:[]};

async function initDB(){
  await neonQuery(`CREATE TABLE IF NOT EXISTS tasks(id TEXT PRIMARY KEY,title TEXT,assignee TEXT,status TEXT,created BIGINT,due_date TEXT,priority TEXT DEFAULT 'medium',description TEXT,category TEXT)`);
  await neonQuery(`CREATE TABLE IF NOT EXISTS calendar_entries(id TEXT PRIMARY KEY,date TEXT,title TEXT,description TEXT,time TEXT,category TEXT)`);
  await neonQuery(`CREATE TABLE IF NOT EXISTS prompts(id TEXT PRIMARY KEY,prompt TEXT,response TEXT,created BIGINT)`);
  await neonQuery(`CREATE TABLE IF NOT EXISTS documents(id TEXT PRIMARY KEY,title TEXT,content TEXT,created BIGINT,updated BIGINT)`);
  await neonQuery(`CREATE TABLE IF NOT EXISTS content_items(id TEXT PRIMARY KEY,campaign TEXT,platform TEXT,script TEXT,status TEXT,created BIGINT)`);
  // Alter existing tables to add new columns
  try { await neonQuery('ALTER TABLE tasks ADD COLUMN IF NOT EXISTS due_date TEXT') } catch(e){}
  try { await neonQuery('ALTER TABLE tasks ADD COLUMN IF NOT EXISTS priority TEXT DEFAULT \'medium\'') } catch(e){}
  try { await neonQuery('ALTER TABLE tasks ADD COLUMN IF NOT EXISTS description TEXT') } catch(e){}
  try { await neonQuery('ALTER TABLE tasks ADD COLUMN IF NOT EXISTS category TEXT') } catch(e){}
  try { await neonQuery('ALTER TABLE calendar_entries ADD COLUMN IF NOT EXISTS time TEXT') } catch(e){}
  try { await neonQuery('ALTER TABLE calendar_entries ADD COLUMN IF NOT EXISTS category TEXT') } catch(e){}
}

async function seedIfEmpty(){
  const r=await neonQuery('SELECT count(*) as c FROM tasks');
  const count=parseInt(r[0]?.c||'0');
  if(count>0) return;

  const tasks=[
    {id:uid(),title:'Launch AI sandbox landing page',assignee:'Norman (AI)',status:'in-progress',created:Date.now(),priority:'high',category:'business',description:'Design and deploy the initial landing page for RazorEdge AI',due_date:'2026-03-10'},
    {id:uid(),title:'Get first 3 paying clients',assignee:'Rezah',status:'pending',created:Date.now(),priority:'urgent',category:'business',description:'Close deals with at least 3 paying customers',due_date:'2026-03-31'},
    {id:uid(),title:'30-day expense audit',assignee:'Rezah',status:'pending',created:Date.now(),priority:'high',category:'personal',description:'Review all expenses over the past 30 days',due_date:'2026-03-15'},
    {id:uid(),title:'Set up razoredge.co.za domain',assignee:'Rezah',status:'pending',created:Date.now(),priority:'medium',category:'business',description:'',due_date:'2026-03-05'},
    {id:uid(),title:'Deploy landing page to Vercel',assignee:'Norman (AI)',status:'pending',created:Date.now(),priority:'medium',category:'business',description:'',due_date:'2026-03-07'},
    {id:uid(),title:'Validate pricing with 5 potential customers',assignee:'Rezah',status:'pending',created:Date.now(),priority:'high',category:'business',description:'Get feedback on pricing model',due_date:'2026-03-20'},
    {id:uid(),title:'Build 15-lead pipeline for Q2',assignee:'Rezah',status:'pending',created:Date.now(),priority:'medium',category:'business',description:'',due_date:'2026-06-30'},
    {id:uid(),title:'Negotiate corporate raise/bonus',assignee:'Rezah',status:'pending',created:Date.now(),priority:'low',category:'personal',description:'',due_date:''}
  ];
  for(const t of tasks) await neonQuery('INSERT INTO tasks(id,title,assignee,status,created,due_date,priority,description,category) VALUES($1,$2,$3,$4,$5,$6,$7,$8,$9)',[t.id,t.title,t.assignee,t.status,t.created,t.due_date,t.priority,t.description,t.category]);

  const cal=[
    {id:uid(),date:'2026-02-25',title:'Norman activated ‚Äî Mission Control online',description:'',time:'',category:'business'},
    {id:uid(),date:'2026-03-01',title:'Q1 starts ‚Äî 90-day sprint begins',description:'',time:'08:00',category:'business'},
    {id:uid(),date:'2026-03-31',title:'Q1 review ‚Äî 3 clients target',description:'',time:'09:00',category:'deadline'},
    {id:uid(),date:'2026-06-30',title:'Q2 review ‚Äî 12 clients target',description:'',time:'09:00',category:'deadline'}
  ];
  for(const e of cal) await neonQuery('INSERT INTO calendar_entries(id,date,title,description,time,category) VALUES($1,$2,$3,$4,$5,$6)',[e.id,e.date,e.title,e.description,e.time,e.category]);

  const ci={id:uid(),campaign:'RazorEdge AI Launch',platform:'LinkedIn',script:'Introducing RazorEdge AI ‚Äî pre-configured AI hardware for South African businesses. No tech skills needed. From R3,500.',status:'draft',created:Date.now()};
  await neonQuery('INSERT INTO content_items(id,campaign,platform,script,status,created) VALUES($1,$2,$3,$4,$5,$6)',[ci.id,ci.campaign,ci.platform,ci.script,ci.status,ci.created]);
}

async function loadFromDB(table){
  const map={tasks:'tasks',calendar:'calendar_entries',prompts:'prompts',documents:'documents',content:'content_items'};
  const rows=await neonQuery(`SELECT * FROM ${map[table]} ORDER BY ${table==='calendar'?'"date"':'created'} ${table==='calendar'?'ASC':'DESC'}`);
  cache[table]=rows||[];
  return cache[table];
}

function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6)}

// ---- Tab switching ----
let currentTab='brief';
function switchTab(t){
  currentTab=t;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab===t));
  render();
}

// ---- Render dispatcher ----
async function render(){
  const el=document.getElementById('content');
  await ({brief:renderDailyBrief,radar:renderRadar,tasks:renderTasks,calendar:renderCalendar,prompts:renderPrompts,documents:renderDocuments,content:renderContent})[currentTab](el);
}

// ---- 0. DAILY BRIEF ----
function timeAgo(dateStr){
  if(!dateStr)return '';
  const s=Math.floor((Date.now()-new Date(dateStr).getTime())/1000);
  if(s<60)return 'just now';if(s<3600)return Math.floor(s/60)+'m ago';
  if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';
}
async function renderDailyBrief(el){
  el.innerHTML=`<h2><span class="section-icon">‚óà</span> DAILY BRIEF</h2>
    <div class="toolbar"><button onclick="fetchBrief(true)">‚Üª Refresh</button><span id="briefGenTime" style="font-size:.7rem;color:var(--dim);margin-left:auto"></span></div>
    <div id="briefContent"><div class="loading-bar">[ FETCHING DAILY BRIEF... ]</div></div>`;
  fetchBrief(false);
}
async function fetchBrief(force){
  const el=document.getElementById('briefContent');
  if(!el)return;
  if(force)el.innerHTML='<div class="loading-bar">[ REFRESHING... ]</div>';
  try{
    const r=await fetch('/api/brief');
    if(!r.ok)throw new Error('HTTP '+r.status);
    const data=await r.json();
    const gt=document.getElementById('briefGenTime');
    if(gt)gt.textContent='Generated: '+new Date(data.generated).toLocaleString();
    const icons={ai:'[AI]',sa:'[SA]',world:'[WORLD]'};
    const labels={ai:'AI DEVELOPMENTS',sa:'SOUTH AFRICA',world:'WORLD NEWS'};
    let html='';
    for(const key of ['ai','sa','world']){
      const sec=data.sections[key];
      html+=`<div style="margin-bottom:24px"><h2 style="font-size:.95rem;margin-bottom:10px"><span style="color:var(--green)">${icons[key]}</span> ${labels[key]}</h2>`;
      if(!sec||!sec.items.length){html+='<div class="empty">No items available.</div>';html+='</div>';continue;}
      html+=sec.items.map(i=>`<div class="card" style="padding:12px">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
          <a href="${esc(i.link)}" target="_blank" rel="noopener" style="color:var(--green);text-decoration:none;font-size:.85rem;flex:1">${esc(i.title)}</a>
          <div style="display:flex;gap:6px;flex-shrink:0;align-items:center">
            <span class="badge" style="border-color:var(--dark-green);color:var(--dim)">${esc(i.source)}</span>
            <span style="font-size:.65rem;color:var(--dim);white-space:nowrap">${timeAgo(i.date)}</span>
          </div>
        </div>
        ${i.snippet?`<div style="font-size:.75rem;color:var(--dim);margin-top:6px;line-height:1.4">${esc(i.snippet)}</div>`:''}
      </div>`).join('');
      html+='</div>';
    }
    el.innerHTML=html;
  }catch(e){
    el.innerHTML=`<div class="empty">[ BRIEF UNAVAILABLE: ${esc(e.message)} ]<br><br><button onclick="fetchBrief(true)">Retry</button></div>`;
  }
}

// ---- 0.5 TREND RADAR ----
async function renderRadar(el){
  el.innerHTML=`<h2><span class="section-icon">‚óé</span> TREND RADAR</h2>
    <div class="toolbar">
      <button onclick="fetchRadar(true)">‚Üª Refresh</button>
      <span class="radar-tooltip" data-tip="Social Arbitrage: Spot consumer behaviour shifts before Wall Street prices them in. Based on Chris Camillo's methodology ‚Äî detect information imbalances across multiple sources.">‚Ñπ What is this?</span>
      <span id="radarTime" style="font-size:.7rem;color:var(--dim);margin-left:auto"></span>
    </div>
    <div id="radarContent"><div class="loading-bar">[ SCANNING TREND SIGNALS... ]</div></div>`;
  fetchRadar(false);
}
async function fetchRadar(force){
  const el=document.getElementById('radarContent');
  if(!el)return;
  if(force)el.innerHTML='<div class="loading-bar">[ REFRESHING SIGNALS... ]</div>';
  try{
    const r=await fetch('/api/trends'+(force?'?force=1':''));
    if(!r.ok)throw new Error('HTTP '+r.status);
    const data=await r.json();
    const gt=document.getElementById('radarTime');
    if(gt)gt.textContent='Updated: '+new Date(data.generated).toLocaleString();

    const sigs=data.signals;
    const totalItems=Object.values(sigs).reduce((n,s)=>n+(s.items||[]).length,0);
    const strongCount=(data.insights||[]).filter(i=>i.signal_strength==='strong').length;
    const online=Object.values(sigs).filter(s=>s.status==='online').length;
    const total=Object.keys(sigs).length;

    let html=`<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:24px">
      <div class="radar-stat"><div class="val">${totalItems}</div><div class="lbl">SIGNALS</div></div>
      <div class="radar-stat"><div class="val" style="color:#0f6">${strongCount}</div><div class="lbl">STRONG</div></div>
      <div class="radar-stat"><div class="val">${online}/${total}</div><div class="lbl">SOURCES</div></div>
      <div class="radar-stat"><div class="val">${(data.insights||[]).length}</div><div class="lbl">INSIGHTS</div></div>
    </div>`;

    // Cross-signal insights
    if(data.insights&&data.insights.length){
      html+=`<div class="radar-section"><h3>‚ö° CROSS-SIGNAL INSIGHTS</h3>`;
      html+=data.insights.map(i=>`<div class="insight-card ${i.signal_strength}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:8px">
          <div style="flex:1;font-size:.85rem">${esc(i.trend)}</div>
          <span class="strength-badge ${i.signal_strength}">${i.signal_strength}</span>
        </div>
        <div style="margin-bottom:6px">${i.sources.map(s=>`<span class="src-badge">${esc(s)}</span>`).join('')}
          <span class="badge" style="border-color:var(--dim);color:var(--dim);margin-left:4px">${esc(i.category)}</span></div>
        ${i.potential_plays?`<div style="font-size:.75rem;color:var(--dim);margin-top:4px">üí° ${esc(i.potential_plays)}</div>`:''}
      </div>`).join('');
      html+=`</div>`;
    }

    // Source feeds
    const sections=[
      {key:'google_trends_za',icon:'üáøüá¶',render:i=>`<div class="radar-item"><a href="${esc(i.link)}" target="_blank">${esc(i.title)}</a><div class="metrics">${i.traffic?`<span>üìà ${esc(i.traffic)}</span>`:''}</div></div>`},
      {key:'google_trends_us',icon:'üåç',render:i=>`<div class="radar-item"><a href="${esc(i.link)}" target="_blank">${esc(i.title)}</a><div class="metrics">${i.traffic?`<span>üìà ${esc(i.traffic)}</span>`:''}</div></div>`},
      {key:'reddit_hot',icon:'üí¨',render:i=>`<div class="radar-item"><a href="${esc(i.link)}" target="_blank">${esc(i.title)}</a><div class="metrics"><span>r/${esc(i.subreddit)}</span><span>‚ñ≤${i.score}</span><span>üí¨${i.comments}</span></div></div>`},
      {key:'hacker_news',icon:'‚ö°',render:i=>`<div class="radar-item"><a href="${esc(i.link)}" target="_blank">${esc(i.title)}</a><div class="metrics"><span>‚ñ≤${i.score}</span><span>üí¨${i.comments}</span></div></div>`}
    ];

    for(const sec of sections){
      const s=sigs[sec.key];
      if(!s)continue;
      const statusBadge=s.status==='online'?'<span style="color:#0f6;font-size:.7rem">‚óè online</span>':'<span style="color:#f44;font-size:.7rem">‚óè failed</span>';
      html+=`<div class="radar-section"><h3>${sec.icon} ${esc(s.label)} ${statusBadge}</h3>`;
      if(!s.items||!s.items.length){html+=`<div class="empty" style="padding:12px">No data available</div>`;
      }else{
        html+=`<div class="card" style="padding:0;overflow:hidden">${s.items.map(sec.render).join('')}</div>`;
      }
      html+=`</div>`;
    }

    el.innerHTML=html;
  }catch(e){
    el.innerHTML=`<div class="empty">[ RADAR UNAVAILABLE: ${esc(e.message)} ]<br><br><button onclick="fetchRadar(true)">Retry</button></div>`;
  }
}

// ---- 1. TASKS ----
let taskFilterValue='all';
let taskAssigneeFilter='all';
let taskCategoryFilter='all';
let taskPriorityFilter='all';
let taskSortBy='created';

function getDueClass(due_date){
  if(!due_date)return '';
  const today=new Date();today.setHours(0,0,0,0);
  const d=new Date(due_date+'T00:00:00');
  if(d<today)return 'due-overdue';
  if(d.getTime()===today.getTime())return 'due-today';
  return 'due-future';
}

function formatDueDate(due_date){
  if(!due_date)return '';
  const d=new Date(due_date+'T00:00:00');
  return d.toLocaleDateString('en-ZA',{day:'numeric',month:'short',year:'numeric'});
}

const priorityOrder={urgent:0,high:1,medium:2,low:3};

async function renderTasks(el){
  const tasks=await loadFromDB('tasks');
  el.innerHTML=`<h2><span class="section-icon">‚ñ∫</span> TASKS</h2>
    <div class="toolbar">
      <button onclick="addTask()">+ New Task</button>
      <select onchange="taskFilterValue=this.value;render()" style="width:auto">
        <option value="all"${taskFilterValue==='all'?' selected':''}>All Status</option>
        <option value="pending"${taskFilterValue==='pending'?' selected':''}>Pending</option>
        <option value="in-progress"${taskFilterValue==='in-progress'?' selected':''}>In Progress</option>
        <option value="done"${taskFilterValue==='done'?' selected':''}>Done</option>
      </select>
      <select onchange="taskAssigneeFilter=this.value;render()" style="width:auto">
        <option value="all"${taskAssigneeFilter==='all'?' selected':''}>All Assignees</option>
        <option value="Rezah"${taskAssigneeFilter==='Rezah'?' selected':''}>Rezah</option>
        <option value="Norman (AI)"${taskAssigneeFilter==='Norman (AI)'?' selected':''}>Norman (AI)</option>
      </select>
      <select onchange="taskCategoryFilter=this.value;render()" style="width:auto">
        <option value="all"${taskCategoryFilter==='all'?' selected':''}>All Categories</option>
        <option value="business"${taskCategoryFilter==='business'?' selected':''}>Business</option>
        <option value="personal"${taskCategoryFilter==='personal'?' selected':''}>Personal</option>
        <option value="health"${taskCategoryFilter==='health'?' selected':''}>Health</option>
        <option value="family"${taskCategoryFilter==='family'?' selected':''}>Family</option>
        <option value="spiritual"${taskCategoryFilter==='spiritual'?' selected':''}>Spiritual</option>
      </select>
      <select onchange="taskPriorityFilter=this.value;render()" style="width:auto">
        <option value="all"${taskPriorityFilter==='all'?' selected':''}>All Priorities</option>
        <option value="urgent"${taskPriorityFilter==='urgent'?' selected':''}>Urgent</option>
        <option value="high"${taskPriorityFilter==='high'?' selected':''}>High</option>
        <option value="medium"${taskPriorityFilter==='medium'?' selected':''}>Medium</option>
        <option value="low"${taskPriorityFilter==='low'?' selected':''}>Low</option>
      </select>
      <select onchange="taskSortBy=this.value;render()" style="width:auto">
        <option value="created"${taskSortBy==='created'?' selected':''}>Sort: Created</option>
        <option value="due_date"${taskSortBy==='due_date'?' selected':''}>Sort: Due Date</option>
        <option value="priority"${taskSortBy==='priority'?' selected':''}>Sort: Priority</option>
      </select>
    </div>
    <div id="taskList"></div>`;
  let filtered=tasks.filter(t=>{
    if(taskFilterValue!=='all'&&t.status!==taskFilterValue)return false;
    if(taskAssigneeFilter!=='all'&&t.assignee!==taskAssigneeFilter)return false;
    if(taskCategoryFilter!=='all'&&t.category!==taskCategoryFilter)return false;
    if(taskPriorityFilter!=='all'&&t.priority!==taskPriorityFilter)return false;
    return true;
  });
  filtered.sort((a,b)=>{
    if(taskSortBy==='priority')return (priorityOrder[a.priority]??2)-(priorityOrder[b.priority]??2);
    if(taskSortBy==='due_date'){
      if(!a.due_date&&!b.due_date)return 0;
      if(!a.due_date)return 1;if(!b.due_date)return -1;
      return a.due_date.localeCompare(b.due_date);
    }
    return (Number(b.created)||0)-(Number(a.created)||0);
  });
  document.getElementById('taskList').innerHTML=filtered.length?filtered.map(t=>`
    <div class="card" style="cursor:pointer" onclick="editTask('${t.id}')">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
        <div style="flex:1;min-width:0">
          <div style="font-size:.9rem;font-weight:bold">${esc(t.title)}</div>
          ${t.description?`<div class="task-desc">${esc(t.description)}</div>`:''}
          <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;align-items:center">
            <span class="badge ${t.status||'pending'}">${t.status||'pending'}</span>
            ${t.priority?`<span class="badge ${t.priority}">${t.priority}</span>`:''}
            ${t.category?`<span class="badge ${t.category}">${t.category}</span>`:''}
            ${t.assignee?`<span class="badge" style="border-color:var(--dim);color:var(--dim)">${esc(t.assignee)}</span>`:''}
            ${t.due_date?`<span class="${getDueClass(t.due_date)}" style="font-size:.7rem">üìÖ ${formatDueDate(t.due_date)}</span>`:''}
          </div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-shrink:0" onclick="event.stopPropagation()">
          <select onchange="updateTaskStatus('${t.id}',this.value)" style="width:auto;font-size:.7rem;padding:2px 4px">
            <option ${t.status==='pending'?'selected':''} value="pending">pending</option>
            <option ${t.status==='in-progress'?'selected':''} value="in-progress">in-progress</option>
            <option ${t.status==='done'?'selected':''} value="done">done</option>
          </select>
          <button class="edit-btn" onclick="editTask('${t.id}')">‚úé</button>
          <button class="delete-btn" onclick="deleteItem('tasks','${t.id}')">‚úï</button>
        </div>
      </div>
    </div>`).join(''):'<div class="empty">No tasks match filters. Click + New Task to begin.</div>';
}

function taskFormHTML(t){
  t=t||{title:'',description:'',assignee:'Rezah',due_date:'',priority:'medium',category:'',status:'pending'};
  return `
  <div class="form-row"><label>Title *</label><input id="mTitle" value="${esc(t.title)}"></div>
  <div class="form-row"><label>Description</label><textarea id="mDesc">${esc(t.description||'')}</textarea></div>
  <div class="form-row"><label>Assignee</label><select id="mAssignee" style="width:100%">
    <option value="Rezah"${t.assignee==='Rezah'?' selected':''}>Rezah</option>
    <option value="Norman (AI)"${t.assignee==='Norman (AI)'?' selected':''}>Norman (AI)</option>
  </select></div>
  <div class="form-row"><label>Due Date</label><input id="mDueDate" type="date" value="${esc(t.due_date||'')}"></div>
  <div class="form-row"><label>Priority</label><select id="mPriority" style="width:100%">
    <option value="low"${t.priority==='low'?' selected':''}>Low</option>
    <option value="medium"${(t.priority==='medium'||!t.priority)?' selected':''}>Medium</option>
    <option value="high"${t.priority==='high'?' selected':''}>High</option>
    <option value="urgent"${t.priority==='urgent'?' selected':''}>Urgent</option>
  </select></div>
  <div class="form-row"><label>Category</label><select id="mCategory" style="width:100%">
    <option value="">‚Äî None ‚Äî</option>
    <option value="business"${t.category==='business'?' selected':''}>Business</option>
    <option value="personal"${t.category==='personal'?' selected':''}>Personal</option>
    <option value="health"${t.category==='health'?' selected':''}>Health</option>
    <option value="family"${t.category==='family'?' selected':''}>Family</option>
    <option value="spiritual"${t.category==='spiritual'?' selected':''}>Spiritual</option>
  </select></div>
  <div class="form-row"><label>Status</label><select id="mStatus" style="width:100%">
    <option value="pending"${t.status==='pending'?' selected':''}>Pending</option>
    <option value="in-progress"${t.status==='in-progress'?' selected':''}>In Progress</option>
    <option value="done"${t.status==='done'?' selected':''}>Done</option>
  </select></div>`;
}

function getTaskFormValues(){
  return {
    title:document.getElementById('mTitle').value,
    description:document.getElementById('mDesc').value,
    assignee:document.getElementById('mAssignee').value,
    due_date:document.getElementById('mDueDate').value,
    priority:document.getElementById('mPriority').value,
    category:document.getElementById('mCategory').value,
    status:document.getElementById('mStatus').value
  };
}

function addTask(){showModal('New Task',taskFormHTML(),async()=>{
  const v=getTaskFormValues();
  if(!v.title){alert('Title is required');return;}
  const id=uid();
  await neonQuery('INSERT INTO tasks(id,title,assignee,status,created,due_date,priority,description,category) VALUES($1,$2,$3,$4,$5,$6,$7,$8,$9)',
    [id,v.title,v.assignee,v.status,Date.now(),v.due_date,v.priority,v.description,v.category]);
  render();
})}

async function editTask(id){
  const tasks=cache.tasks.length?cache.tasks:await loadFromDB('tasks');
  const t=tasks.find(x=>x.id===id);if(!t)return;
  showModal('Edit Task',taskFormHTML(t),async()=>{
    const v=getTaskFormValues();
    if(!v.title){alert('Title is required');return;}
    await neonQuery('UPDATE tasks SET title=$1,description=$2,assignee=$3,due_date=$4,priority=$5,category=$6,status=$7 WHERE id=$8',
      [v.title,v.description,v.assignee,v.due_date,v.priority,v.category,v.status,id]);
    render();
  });
}

async function updateTaskStatus(id,s){
  await neonQuery('UPDATE tasks SET status=$1 WHERE id=$2',[s,id]);
  render();
}

// ---- 2. CALENDAR ----
let calYear=2026,calMonth=1;
async function renderCalendar(el){
  const entries=await loadFromDB('calendar');
  const d=new Date(calYear,calMonth,1),dow=d.getDay(),dim=new Date(calYear,calMonth+1,0).getDate();
  const prevDim=new Date(calYear,calMonth,0).getDate();
  const mName=d.toLocaleString('default',{month:'long',year:'numeric'});
  const today=new Date();
  el.innerHTML=`<h2><span class="section-icon">‚óÜ</span> CALENDAR</h2>
    <div class="toolbar">
      <button onclick="calNav(-1)">‚óÄ</button>
      <span style="min-width:160px;text-align:center">${mName}</span>
      <button onclick="calNav(1)">‚ñ∂</button>
      <button onclick="addCalEntry()" style="margin-left:auto">+ Entry</button>
    </div>
    <div class="cal-grid">
      ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=>`<div class="cal-header">${d}</div>`).join('')}
      ${buildCalDays(dow,dim,prevDim,entries,today)}
    </div>`;
}
function buildCalDays(dow,dim,prevDim,entries,today){
  let html='';
  for(let i=0;i<dow;i++){html+=`<div class="cal-day other"><span class="num">${prevDim-dow+i+1}</span></div>`}
  for(let d=1;d<=dim;d++){
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday=today.getFullYear()===calYear&&today.getMonth()===calMonth&&today.getDate()===d;
    const dayEntries=entries.filter(e=>e.date===ds);
    html+=`<div class="cal-day${isToday?' today':''}" onclick="showDayEntries('${ds}')">
      <span class="num">${d}</span>
      ${dayEntries.sort((a,b)=>(a.time||'').localeCompare(b.time||'')).slice(0,2).map(e=>`<div class="cal-entry">${e.time?esc(e.time)+' ':''}${esc(e.title)}</div>`).join('')}
      ${dayEntries.length>2?`<div class="cal-entry">+${dayEntries.length-2} more</div>`:''}
    </div>`;
  }
  const rem=(dow+dim)%7;if(rem)for(let i=1;i<=7-rem;i++){html+=`<div class="cal-day other"><span class="num">${i}</span></div>`}
  return html;
}
function calNav(dir){calMonth+=dir;if(calMonth>11){calMonth=0;calYear++}if(calMonth<0){calMonth=11;calYear--}render()}

function calEntryFormHTML(e,prefillDate){
  e=e||{date:prefillDate||'',time:'',title:'',description:'',category:''};
  return `
  <div class="form-row"><label>Date *</label><input id="mDate" type="date" value="${esc(e.date)}"></div>
  <div class="form-row"><label>Time</label><input id="mTime" type="time" value="${esc(e.time||'')}"></div>
  <div class="form-row"><label>Title *</label><input id="mETitle" value="${esc(e.title)}"></div>
  <div class="form-row"><label>Description</label><textarea id="mEDesc">${esc(e.description||'')}</textarea></div>
  <div class="form-row"><label>Category</label><select id="mECategory" style="width:100%">
    <option value="">‚Äî None ‚Äî</option>
    <option value="meeting"${e.category==='meeting'?' selected':''}>Meeting</option>
    <option value="deadline"${e.category==='deadline'?' selected':''}>Deadline</option>
    <option value="personal"${e.category==='personal'?' selected':''}>Personal</option>
    <option value="family"${e.category==='family'?' selected':''}>Family</option>
    <option value="health"${e.category==='health'?' selected':''}>Health</option>
    <option value="spiritual"${e.category==='spiritual'?' selected':''}>Spiritual</option>
    <option value="business"${e.category==='business'?' selected':''}>Business</option>
  </select></div>`;
}

function addCalEntry(prefillDate){showModal('New Calendar Entry',calEntryFormHTML(null,prefillDate),async()=>{
  const id=uid();
  const date=document.getElementById('mDate').value;
  const title=document.getElementById('mETitle').value;
  if(!date||!title){alert('Date and Title are required');return;}
  await neonQuery('INSERT INTO calendar_entries(id,date,title,description,time,category) VALUES($1,$2,$3,$4,$5,$6)',
    [id,date,title,document.getElementById('mEDesc').value,document.getElementById('mTime').value,document.getElementById('mECategory').value]);
  render();
})}

async function editCalEntry(id){
  const entries=cache.calendar.length?cache.calendar:await loadFromDB('calendar');
  const e=entries.find(x=>x.id===id);if(!e)return;
  // Close existing modals
  document.querySelectorAll('.modal-overlay').forEach(m=>m.remove());
  showModal('Edit Calendar Entry',calEntryFormHTML(e),async()=>{
    const date=document.getElementById('mDate').value;
    const title=document.getElementById('mETitle').value;
    if(!date||!title){alert('Date and Title are required');return;}
    await neonQuery('UPDATE calendar_entries SET date=$1,title=$2,description=$3,time=$4,category=$5 WHERE id=$6',
      [date,title,document.getElementById('mEDesc').value,document.getElementById('mTime').value,document.getElementById('mECategory').value,id]);
    render();
  });
}

async function showDayEntries(ds){
  const entries=(await loadFromDB('calendar')).filter(e=>e.date===ds);
  if(!entries.length){
    addCalEntry(ds);
    return;
  }
  const sorted=entries.sort((a,b)=>(a.time||'').localeCompare(b.time||''));
  showModal('Entries for '+ds,
    sorted.map(e=>`<div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <strong>${e.time?esc(e.time)+' ‚Äî ':''}${esc(e.title)}</strong>
          ${e.category?`<span class="badge ${e.category}" style="margin-left:8px">${e.category}</span>`:''}
          ${e.description?`<div style="font-size:.8rem;color:var(--dim);margin-top:4px">${esc(e.description)}</div>`:''}
        </div>
        <div style="display:flex;gap:6px;flex-shrink:0">
          <button class="edit-btn" onclick="editCalEntry('${e.id}')">‚úé</button>
          <button class="delete-btn" onclick="deleteItem('calendar','${e.id}')">‚úï</button>
        </div>
      </div>
    </div>`).join('')+`<div style="margin-top:12px"><button onclick="document.querySelectorAll('.modal-overlay').forEach(m=>m.remove());addCalEntry('${ds}')">+ Add Entry</button></div>`,null);
}

// ---- 3. PROMPTS ----
async function renderPrompts(el){
  const prompts=await loadFromDB('prompts');
  el.innerHTML=`<h2><span class="section-icon">‚óá</span> PROMPT LOG</h2>
    <div class="toolbar">
      <input id="promptSearch" placeholder="Search prompts..." oninput="render()" style="max-width:300px">
      <button onclick="addPrompt()" style="margin-left:auto">+ Log Prompt</button>
    </div><div id="promptList"></div>`;
  const q=(document.getElementById('promptSearch')?.value||'').toLowerCase();
  const filtered=prompts.filter(p=>!q||(p.prompt||'').toLowerCase().includes(q)||(p.response||'').toLowerCase().includes(q));
  document.getElementById('promptList').innerHTML=filtered.length?filtered.map(p=>`
    <div class="card">
      <div style="font-size:.65rem;color:var(--dim);margin-bottom:6px">${new Date(Number(p.created)).toLocaleString()}</div>
      <div style="margin-bottom:8px"><strong style="color:#0f0">PROMPT:</strong> ${esc(p.prompt)}</div>
      <div><strong style="color:var(--dim)">RESPONSE:</strong> ${esc(p.response)}</div>
      <button class="delete-btn" style="margin-top:8px" onclick="deleteItem('prompts','${p.id}')">‚úï</button>
    </div>`).join(''):'<div class="empty">No prompts logged yet.</div>';
}
function addPrompt(){showModal('Log Prompt',`
  <div class="form-row"><label>Prompt</label><textarea id="mPrompt"></textarea></div>
  <div class="form-row"><label>Response</label><textarea id="mResponse"></textarea></div>
`,async()=>{
  const id=uid();
  await neonQuery('INSERT INTO prompts(id,prompt,response,created) VALUES($1,$2,$3,$4)',[id,document.getElementById('mPrompt').value,document.getElementById('mResponse').value,Date.now()]);
  render();
})}

// ---- 4. DOCUMENTS ----
let editingDoc=null;
async function renderDocuments(el){
  const docs=await loadFromDB('documents');
  if(editingDoc){
    const d=docs.find(x=>x.id===editingDoc)||{id:null,title:'',content:''};
    el.innerHTML=`<h2><span class="section-icon">‚ñ£</span> ${d.id?'EDIT':'NEW'} DOCUMENT</h2>
      <div class="form-row"><label>Title</label><input id="docTitle" value="${esc(d.title)}"></div>
      <div class="form-row"><label>Content (Markdown)</label><textarea id="docContent" style="min-height:300px">${esc(d.content)}</textarea></div>
      <div class="toolbar"><button onclick="saveDoc('${d.id}')">Save</button><button onclick="editingDoc=null;render()">Cancel</button></div>`;
    return;
  }
  el.innerHTML=`<h2><span class="section-icon">‚ñ£</span> DOCUMENTS</h2>
    <div class="toolbar"><button onclick="editingDoc='new';render()">+ New Document</button></div>
    <div id="docList"></div>`;
  document.getElementById('docList').innerHTML=docs.length?docs.map(d=>`
    <div class="card" style="cursor:pointer" onclick="viewDoc('${d.id}')">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${esc(d.title)}</strong>
        <div style="display:flex;gap:6px">
          <button onclick="event.stopPropagation();editingDoc='${d.id}';render()" style="font-size:.7rem;padding:4px 8px">Edit</button>
          <button class="delete-btn" onclick="event.stopPropagation();deleteItem('documents','${d.id}')">‚úï</button>
        </div>
      </div>
      <div style="font-size:.7rem;color:var(--dim);margin-top:4px">${new Date(Number(d.updated)).toLocaleDateString()} ‚Ä¢ ${(d.content||'').length} chars</div>
    </div>`).join(''):'<div class="empty">No documents yet.</div>';
}
async function saveDoc(id){
  const title=document.getElementById('docTitle').value,content=document.getElementById('docContent').value,now=Date.now();
  if(id&&id!=='null'){
    await neonQuery('UPDATE documents SET title=$1,content=$2,updated=$3 WHERE id=$4',[title,content,now,id]);
  }else{
    await neonQuery('INSERT INTO documents(id,title,content,created,updated) VALUES($1,$2,$3,$4,$5)',[uid(),title,content,now,now]);
  }
  editingDoc=null;render();
}
async function viewDoc(id){
  const docs=await loadFromDB('documents');
  const d=docs.find(x=>x.id===id);if(!d)return;
  showModal(d.title,`<div style="white-space:pre-wrap;font-size:.85rem;line-height:1.6">${esc(d.content)}</div>`,null);
}

// ---- 5. CONTENT ----
let contentFilterValue='all';
async function renderContent(el){
  const items=await loadFromDB('content');
  el.innerHTML=`<h2><span class="section-icon">‚ñ∂</span> CONTENT TRACKER</h2>
    <div class="toolbar">
      <button onclick="addContent()">+ New Script</button>
      <select id="contentFilter" onchange="contentFilterValue=this.value;render()" style="width:auto">
        <option value="all"${contentFilterValue==='all'?' selected':''}>All</option><option value="draft"${contentFilterValue==='draft'?' selected':''}>Draft</option><option value="review"${contentFilterValue==='review'?' selected':''}>Review</option><option value="published"${contentFilterValue==='published'?' selected':''}>Published</option>
      </select>
    </div><div id="contentList"></div>`;
  const filtered=items.filter(i=>contentFilterValue==='all'||i.status===contentFilterValue);
  document.getElementById('contentList').innerHTML=filtered.length?filtered.map(i=>`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>${esc(i.campaign)}</strong>
        <div style="display:flex;gap:6px;align-items:center">
          <span class="badge ${i.status}">${i.status}</span>
          <select onchange="updateContentStatus('${i.id}',this.value)" style="width:auto;font-size:.7rem;padding:2px 4px">
            <option ${i.status==='draft'?'selected':''} value="draft">draft</option>
            <option ${i.status==='review'?'selected':''} value="review">review</option>
            <option ${i.status==='published'?'selected':''} value="published">published</option>
          </select>
          <button class="delete-btn" onclick="deleteItem('content','${i.id}')">‚úï</button>
        </div>
      </div>
      <div style="font-size:.7rem;color:var(--dim)">Platform: ${esc(i.platform)}</div>
      <div style="font-size:.8rem;margin-top:8px;white-space:pre-wrap;max-height:100px;overflow:hidden">${esc(i.script)}</div>
    </div>`).join(''):'<div class="empty">No content scripts yet.</div>';
}
function addContent(){showModal('New Content Script',`
  <div class="form-row"><label>Campaign Name</label><input id="mCampaign"></div>
  <div class="form-row"><label>Platform</label><input id="mPlatform" placeholder="YouTube, TikTok, Instagram..."></div>
  <div class="form-row"><label>Script</label><textarea id="mScript" style="min-height:120px"></textarea></div>
`,async()=>{
  const id=uid();
  await neonQuery('INSERT INTO content_items(id,campaign,platform,script,status,created) VALUES($1,$2,$3,$4,$5,$6)',[id,document.getElementById('mCampaign').value,document.getElementById('mPlatform').value,document.getElementById('mScript').value,'draft',Date.now()]);
  render();
})}
async function updateContentStatus(id,s){
  await neonQuery('UPDATE content_items SET status=$1 WHERE id=$2',[s,id]);
  render();
}

// ---- Shared: Modal, Delete, Escape ----
function showModal(title,body,onSave){
  const overlay=document.createElement('div');overlay.className='modal-overlay';
  overlay.innerHTML=`<div class="modal"><h3>${title}</h3>${body}<div class="modal-actions">
    ${onSave?'<button onclick="this.closest(\'.modal-overlay\')._save()">Save</button>':''}
    <button onclick="this.closest('.modal-overlay').remove()">Close</button>
  </div></div>`;
  overlay._save=()=>{onSave();overlay.remove()};
  document.body.appendChild(overlay);
}

async function deleteItem(key,id){
  const map={tasks:'tasks',calendar:'calendar_entries',prompts:'prompts',documents:'documents',content:'content_items'};
  await neonQuery(`DELETE FROM ${map[key]} WHERE id=$1`,[id]);
  render();
  document.querySelectorAll('.modal-overlay').forEach(m=>m.remove());
}

function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}

// ---- Init ----
(async()=>{
  try{
    if(currentTab==='brief'){render();}
    await initDB();
    await seedIfEmpty();
    if(currentTab!=='brief'){await render();}
  }catch(e){
    console.error('Init error:',e);
    if(currentTab!=='brief')document.getElementById('content').innerHTML='<div class="empty">[ DATABASE CONNECTION ERROR ‚Äî Check console ]</div>';
  }
})();
</script>
</body>
</html>
